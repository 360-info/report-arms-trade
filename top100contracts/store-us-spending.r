library(tidyverse)
library(arrow)
library(here)

# we're going to _lightly_ preprocess the CSV downlods from
# usaspending.gov in order to store them in a more efficient format on
# the 360 google drive

# https://www.usaspending.gov/download_center/award_data_archive
dir.create(here("data", "contracts", "usa", "unzipped"), recursive = TRUE,
  showWarnings = FALSE)

# unzip files (~ 72 GB unzipped as of aug 2022)
list.files(
  here("data", "contracts", "usa"), pattern = glob2rx("*.zip"),
  full.names = T) %>%
  walk(unzip,
    exdir = here("data", "contracts", "usa", "unzipped"))

schema <- schema(
  contract_transaction_unique_key = string(),
  contract_award_unique_key = string(),
  award_id_piid = string(),
  modification_number = string(),
  transaction_number = uint32(),
  parent_award_agency_id = uint32(),
  parent_award_agency_name = string(),
  parent_award_id_piid = string(),
  parent_award_modification_number = string(),
  federal_action_obligation = float32(),
  total_dollars_obligated = float32(),
  base_and_exercised_options_value = float32(),
  current_total_value_of_award = float32(),
  base_and_all_options_value = float32(),
  potential_total_value_of_award = float32(),
  disaster_emergency_fund_codes_for_overall_award = string(),
  `outlayed_amount_funded_by_COVID-19_supplementals_for_overall_aw` = float32(),
  `obligated_amount_funded_by_COVID-19_supplementals_for_overall_a` = float32(),
  action_date = date32(),
  action_date_fiscal_year = uint16(),
  period_of_performance_start_date = time32(),
  period_of_performance_current_end_date = time32(),
  period_of_performance_potential_end_date = time32(),
  ordering_period_end_date = date32(),
  solicitation_date = date32(),
  awarding_agency_code = string(),
  awarding_agency_name = string(),
  awarding_sub_agency_code = string(),
  awarding_sub_agency_name = string(),
  awarding_office_code = string(),
  awarding_office_name = string(),
  funding_agency_code = string(),
  funding_agency_name = string(),
  funding_sub_agency_code = string(),
  funding_sub_agency_name = string(),
  funding_office_code = string(),
  funding_office_name = string(),
  # treasury_accounts_funding_this_award = 
  # federal_accounts_funding_this_award = 
  # object_classes_funding_this_award = 
  # program_activities_funding_this_award = 
  foreign_funding = string(),
  foreign_funding_description = string(),
  sam_exception = string(),
  sam_exception_description = string(),
  recipient_uei = string(),
  recipient_duns = string(),
  recipient_name = string(),
  recipient_doing_business_as_name = 
  cage_code = 
  recipient_parent_uei = string(),
  recipient_parent_duns = string(),
  recipient_parent_name = string(),
  recipient_country_code = string(),
  recipient_country_name = string(),
  recipient_address_line_1 = string(),
  recipient_address_line_2 = string(),
  recipient_city_name = string(),
  recipient_county_name = string(),
  recipient_state_code = string(),
  recipient_state_name = string(),
  recipient_zip_4_code = uint32(),
  recipient_congressional_district = string(),
  recipient_phone_number = uint32(),
  recipient_fax_number = uint32(),
  primary_place_of_performance_country_code = string(),
  primary_place_of_performance_country_name = string(),
  primary_place_of_performance_city_name = string(),
  primary_place_of_performance_county_name = string(),
  primary_place_of_performance_state_code = string(),
  primary_place_of_performance_state_name = string(),
  primary_place_of_performance_zip_4 = uint32(),
  primary_place_of_performance_congressional_district = string(),
  award_or_idv_flag = string(),
  award_type_code = string(),
  award_type = string(),
  idv_type_code = 
  idv_type = 
  multiple_or_single_award_idv_code = 
  multiple_or_single_award_idv = 
  type_of_idc_code = 
  type_of_idc = 
  type_of_contract_pricing_code = string(),
  type_of_contract_pricing = string(),
  award_description = string(),
  action_type_code = string(),
  action_type = string(),
  solicitation_identifier = string(),
  number_of_actions = uint32(),
  inherently_governmental_functions = 
  inherently_governmental_functions_description = string(),
  product_or_service_code = string(),
  product_or_service_code_description = string(),
  contract_bundling_code = string(),
  contract_bundling = string(),
  dod_claimant_program_code = string(),
  dod_claimant_program_description = string(),
  naics_code = uint32(),
  naics_description = string(),
  recovered_materials_sustainability_code = string(),
  recovered_materials_sustainability = string(),
  domestic_or_foreign_entity_code = 
  domestic_or_foreign_entity = 
  dod_acquisition_program_code = string(),
  dod_acquisition_program_description = string(),
  information_technology_commercial_item_category_code = string(),
  information_technology_commercial_item_category = string(),
  epa_designated_product_code = string(),
  epa_designated_product = string(),
  country_of_product_or_service_origin_code = string(),
  country_of_product_or_service_origin = string(),
  place_of_manufacture_code = string(),
  place_of_manufacture = string(),
  subcontracting_plan_code = string(),
  subcontracting_plan = string(),
  extent_competed_code = string(),
  extent_competed = string(),
  solicitation_procedures_code = string(),
  solicitation_procedures = string(),
  type_of_set_aside_code = string(),
  type_of_set_aside = string(),
  evaluated_preference_code = string(),
  evaluated_preference = string(),
  research_code = 
  research = 
  fair_opportunity_limited_sources_code = 
  fair_opportunity_limited_sources = 
  other_than_full_and_open_competition_code = string(),
  other_than_full_and_open_competition = string(),
  number_of_offers_received = uint32(),
  commercial_item_acquisition_procedures_code = string(),
  commercial_item_acquisition_procedures = string(),
  small_business_competitiveness_demonstration_program = boolean(),
  simplified_procedures_for_certain_commercial_items_code = string(),
  simplified_procedures_for_certain_commercial_items = string(),
  a76_fair_act_action_code = string(),
  a76_fair_act_action = string(),
  fed_biz_opps_code = string(),
  fed_biz_opps = string(),
  local_area_set_aside_code = string(),
  local_area_set_aside = string(),
  price_evaluation_adjustment_preference_percent_difference = float32(),
  clinger_cohen_act_planning_code = string(),
  clinger_cohen_act_planning = string(),
  materials_supplies_articles_equipment_code = string(),
  materials_supplies_articles_equipment = string(),
  labor_standards_code = string(),
  labor_standards = string(),
  construction_wage_rate_requirements_code = string(),
  construction_wage_rate_requirements = string(),
  interagency_contracting_authority_code = string(),
  interagency_contracting_authority = string(),
  other_statutory_authority = 
  program_acronym = 
  parent_award_type_code = string(),
  parent_award_type = string(),
  parent_award_single_or_multiple_code = string(),
  parent_award_single_or_multiple = string(),
  major_program = 
  national_interest_action_code = string(),
  national_interest_action = string(),
  cost_or_pricing_data_code = string(),
  cost_or_pricing_data = string(),
  cost_accounting_standards_clause_code = string(),
  cost_accounting_standards_clause = string(),
  government_furnished_property_code = string(),
  government_furnished_property = string(),
  sea_transportation_code = string(),
  sea_transportation = string(),
  undefinitized_action_code = string(),
  undefinitized_action = string(),
  consolidated_contract_code = string(),
  consolidated_contract = string(),
  performance_based_service_acquisition_code = string(),
  performance_based_service_acquisition = string(),
  multi_year_contract_code = string(),
  multi_year_contract = string(),
  contract_financing_code = string(),
  contract_financing = string(),
  purchase_card_as_payment_method_code = string(),
  purchase_card_as_payment_method = string(),
  contingency_humanitarian_or_peacekeeping_operation_code = 
  contingency_humanitarian_or_peacekeeping_operation = 
  alaskan_native_corporation_owned_firm = boolean(),
  american_indian_owned_business = boolean(),
  indian_tribe_federally_recognized = boolean(),
  native_hawaiian_organization_owned_firm = boolean(),
  tribally_owned_firm = boolean(),
  veteran_owned_business = boolean(),
  service_disabled_veteran_owned_business = boolean(),
  woman_owned_business = boolean(),
  women_owned_small_business = boolean(),
  economically_disadvantaged_women_owned_small_business = boolean(),
  joint_venture_women_owned_small_business = boolean(),
  joint_venture_economic_disadvantaged_women_owned_small_bus = boolean(),
  minority_owned_business = boolean(),
  subcontinent_asian_asian_indian_american_owned_business = boolean(),
  asian_pacific_american_owned_business = boolean(),
  black_american_owned_business = boolean(),
  hispanic_american_owned_business = boolean(),
  native_american_owned_business = boolean(),
  other_minority_owned_business = boolean(),
  contracting_officers_determination_of_business_size = string(),
  contracting_officers_determination_of_business_size_code = string(),
  emerging_small_business = boolean(),
  community_developed_corporation_owned_firm = boolean(),
  labor_surplus_area_firm = boolean(),
  us_federal_government = boolean(),
  federally_funded_research_and_development_corp = boolean(),
  federal_agency = boolean(),
  us_state_government = boolean(),
  us_local_government = boolean(),
  city_local_government = boolean(),
  county_local_government = boolean(),
  inter_municipal_local_government = boolean(),
  local_government_owned = boolean(),
  municipality_local_government = boolean(),
  school_district_local_government = boolean(),
  township_local_government = boolean(),
  us_tribal_government = boolean(),
  foreign_government = boolean(),
  organizational_type = string(),
  corporate_entity_not_tax_exempt = boolean(),
  corporate_entity_tax_exempt = boolean(),
  partnership_or_limited_liability_partnership = boolean(),
  sole_proprietorship = boolean(),
  small_agricultural_cooperative = boolean(),
  international_organization = boolean(),
  us_government_entity = boolean(),
  community_development_corporation = boolean(),
  domestic_shelter = boolean(),
  educational_institution = boolean(),
  foundation = boolean(),
  hospital_flag = boolean(),
  manufacturer_of_goods = boolean(),
  veterinary_hospital = boolean(),
  hispanic_servicing_institution = boolean(),
  receives_contracts = boolean(),
  receives_financial_assistance = boolean(),
  receives_contracts_and_financial_assistance = boolean(),
  airport_authority = boolean(),
  council_of_governments = boolean(),
  housing_authorities_public_tribal = boolean(),
  interstate_entity = boolean(),
  planning_commission = boolean(),
  port_authority = boolean(),
  transit_authority = boolean(),
  subchapter_scorporation = boolean(),
  limited_liability_corporation = boolean(),
  foreign_owned = boolean(),
  for_profit_organization = boolean(),
  nonprofit_organization = boolean(),
  other_not_for_profit_organization = boolean(),
  the_ability_one_program = boolean(),
  private_university_or_college = boolean(),
  state_controlled_institution_of_higher_learning = boolean(),
  1862_land_grant_college = boolean(),
  1890_land_grant_college = boolean(),
  1994_land_grant_college = boolean(),
  minority_institution = boolean(),
  historically_black_college = boolean(),
  tribal_college = boolean(),
  alaskan_native_servicing_institution = boolean(),
  native_hawaiian_servicing_institution = boolean(),
  school_of_forestry = boolean(),
  veterinary_college = boolean(),
  dot_certified_disadvantage = boolean(),
  self_certified_small_disadvantaged_business = boolean(),
  small_disadvantaged_business = boolean(),
  c8a_program_participant = boolean(),
  historically_underutilized_business_zone_hubzone_firm = boolean(),
  sba_certified_8a_joint_venture = boolean(),
  highly_compensated_officer_1_name = string(),
  highly_compensated_officer_1_amount = float32(),
  highly_compensated_officer_2_name = string(),
  highly_compensated_officer_2_amount = float32(),
  highly_compensated_officer_3_name = string(),
  highly_compensated_officer_3_amount = float32(),
  highly_compensated_officer_4_name = string(),
  highly_compensated_officer_4_amount = float32(),
  highly_compensated_officer_5_name = string(),
  highly_compensated_officer_5_amount = float32(),
  usaspending_permalink = string(),
  last_modified_date = time32())

# create an arrow dataset of all the csvs, then write out to parquet file
# (this will take a ~while~)
here("data", "contracts", "usa", "unzipped") %>%
  open_dataset(format = "csv", newlines_in_values = TRUE, schema = schema) ->
all_data

all_data %>% write_dataset(
  here("data", "contracts", "usa", "us-dod-contracts-all.parquet"),
  format = "parquet")
